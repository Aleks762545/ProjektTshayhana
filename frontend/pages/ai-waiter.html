<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ó–∞–∫–∞–∑ —Å –ò–ò</title>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ CSS –∫–∞–∫ –≤ –º–µ–Ω—é -->
<link rel="stylesheet" href="../css/main.css" />
<link rel="stylesheet" href="../css/menu.css" />

<style>
  /* ===== –ù–ê–°–¢–†–û–ô–ö–ò –¶–í–ï–¢–û–í –ò –¢–ï–ú–´ ===== */
  :root {
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã */
    --color-primary: #131313;
    --color-secondary: #2a2a2a;
    --color-surface: rgba(29, 29, 29, 0.95);
    --color-card: rgba(45, 45, 45, 0.8);
    
    /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ (–æ—Ä–∞–Ω–∂–µ–≤–∞—è –≥–∞–º–º–∞) */
    --color-accent: #b56c28;
    --color-accent-hover: #b56c28;
    --color-accent-light: rgba(249, 115, 22, 0.1);
    
    /* –¢–µ–∫—Å—Ç */
    --color-text-primary: #f8fafc;
    --color-text-secondary: #cbd5e1;
    --color-text-muted: #94a3b8;
    
    /* –ì—Ä–∞–Ω–∏—Ü—ã –∏ —Ç–µ–Ω–∏ */
    --color-border: #553d33;
    --shadow-card: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    --shadow-elevated: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
    
    /* –†–∞–¥–∏—É—Å—ã */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    --transition-fast: 150ms ease;
    --transition-base: 250ms ease;
    --transition-slow: 350ms ease;
  }
  
  /* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
  body.page {
    background-image: url('../assets/bg.jpg');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: var(--color-text-primary);
    min-height: 100vh;
    margin: 0;
    padding: 0;
    position: relative;
    overflow-x: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ —Å–¥–≤–∏–≥–µ */
  }
  
  /* ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ===== */
  .ai-page-wrapper {
    width: 100%;
    max-width: 800px;
    height: 72vh;
    min-height: 600px;
    max-height: 800px;
    margin: 40px auto;
    position: relative;
    display: flex;
    justify-content: center;
    transition: transform 0.3s ease, margin-right 0.3s ease;
    will-change: transform; /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
  }
  
  /* –ö–æ–≥–¥–∞ –∫–æ—Ä–∑–∏–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞ - —Å–¥–≤–∏–≥–∞–µ–º —á–∞—Ç –≤–ª–µ–≤–æ */
  body.cart-open .ai-page-wrapper {
    transform: translateX(-200px);
    margin-right: 400px;
  }
  
  /* ===== –ö–û–ù–¢–ï–ô–ù–ï–† –ß–ê–¢–ê ===== */
  .ai-chat-card {
    width: 100%;
    height: 100%;
    background: var(--color-surface);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-card);
    display: flex;
    flex-direction: column;
    position: relative;
    transition: all var(--transition-base);
    overflow: hidden;
  }
  
  .ai-chat-card.with-recs {
    margin-bottom: 300px;
  }
  
  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ */
  .ai-chat-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--color-border);
    background: rgba(22, 22, 22, 0.8);
    flex-shrink: 0;
  }
  
  .ai-chat-title {
    margin: 0;
    font-size: 22px;
    font-weight: 600;
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .ai-chat-title::before {
    content: "";
    font-size: 20px;
  }
  
  .ai-chat-subtitle {
    color: var(--color-text-muted);
    font-size: 14px;
    margin-top: 4px;
  }
  
  /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }
  
  /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
  .messages::-webkit-scrollbar {
    width: 8px;
  }
  
  .messages::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .messages::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
  }
  
  .messages::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent);
  }
  
  /* –°–æ–æ–±—â–µ–Ω–∏—è */
  .message {
    max-width: 75%;
    padding: 14px 18px;
    border-radius: var(--radius-md);
    font-size: 15px;
    line-height: 1.5;
    animation: fadeIn var(--transition-fast);
    position: relative;
    word-wrap: break-word;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message.user {
    margin-left: auto;
    background: linear-gradient(135deg, var(--color-accent), #fb923c);
    color: white;
    border-bottom-right-radius: var(--radius-sm);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
  }
  
  .message.bot {
    background: var(--color-secondary);
    border: 1px solid var(--color-border);
    color: var(--color-text-primary);
    border-bottom-left-radius: var(--radius-sm);
  }
  
  /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
  .message::after {
    content: attr(data-time);
    position: absolute;
    bottom: -18px;
    font-size: 11px;
    color: var(--color-text-muted);
    white-space: nowrap;
  }
  
  .message.user::after {
    right: 0;
  }
  
  .message.bot::after {
    left: 0;
  }
  
  /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
  .composer {
    padding: 20px 24px;
    border-top: 1px solid var(--color-border);
    background: rgba(33, 33, 33, 0.8);
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-shrink: 0;
  }
  
  .composer textarea {
    flex: 1;
    min-height: 48px;
    max-height: 120px;
    border-radius: var(--radius-md);
    padding: 14px 18px;
    border: 1px solid var(--color-border);
    background: var(--color-secondary);
    color: var(--color-text-primary);
    font-size: 15px;
    line-height: 1.5;
    resize: none;
    transition: all var(--transition-fast);
    font-family: inherit;
  }
  
  .composer textarea:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-light);
  }
  
  .composer textarea::placeholder {
    color: var(--color-text-muted);
  }
  
  .composer button {
    padding: 14px 28px;
    border-radius: var(--radius-md);
    background: var(--color-accent);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
    flex-shrink: 0;
    height: 52px;
    font-size: 15px;
    min-width: 120px;
  }
  
  .composer button:hover {
    background: var(--color-accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
  }
  
  .composer button:active {
    transform: translateY(0);
  }
  
  .composer button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  /* ===== –ü–ê–ù–ï–õ–¨ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô ===== */
  .ai-recommendations {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 24px;
    width: calc(100% - 48px);
    max-width: 800px;
    z-index: 1000;
    transition: transform 0.3s ease, left 0.3s ease;
    will-change: transform; /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
  }
  
  /* –ö–æ–≥–¥–∞ –∫–æ—Ä–∑–∏–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞ - —Å–¥–≤–∏–≥–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤–ª–µ–≤–æ */
  body.cart-open .ai-recommendations {
    transform: translateX(-50%) translateX(-200px);
  }
  
  .mini-bar {
    background: var(--color-surface);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-card);
  }
  
  .mini-bar:hover {
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
  }
  
  .mini-bar-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .mini-bar-title {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 16px;
  }
  
  .mini-bar-subtitle {
    color: var(--color-text-muted);
    font-size: 14px;
  }
  
  #toggleRecs {
    background: var(--color-accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    min-width: 100px;
  }
  
  #toggleRecs:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }
  
  /* –ü–∞–Ω–µ–ª—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π */
  .recommendation-panel {
    margin-top: 12px;
    background: var(--color-surface);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    padding: 24px;
    box-shadow: var(--shadow-elevated);
    display: none;
    animation: slideUp var(--transition-base);
    max-height: 400px;
    overflow-y: auto;
  }
  
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .recommendation-panel.open {
    display: block;
  }
  
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }
  
  .dish-card {
    background: var(--color-secondary);
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
    height: 100%;
  }
  
  .dish-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-accent);
    box-shadow: 0 12px 30px rgba(249, 115, 22, 0.2);
  }
  
  .dish-card .img {
    height: 140px;
    background-size: cover;
    background-position: center;
    background-color: var(--color-primary);
    position: relative;
  }
  
  .dish-card .img::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.3));
  }
  
  .dish-card .body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: calc(100% - 140px);
  }
  
  .dish-card h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--color-text-primary);
    line-height: 1.4;
  }
  
  .dish-card p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: 14px;
    line-height: 1.5;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    max-height: 4.5em;
  }
  
  .dish-card .row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-top: auto;
  }
  
  .dish-card .price {
    font-weight: 700;
    color: var(--color-accent);
    font-size: 18px;
  }
  
  .dish-card button {
    border-radius: var(--radius-sm);
    padding: 8px 16px;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    font-weight: 500;
  }
  
  .dish-card .add-btn {
    background: var(--color-accent);
    color: white;
  }
  
  .dish-card .add-btn:hover {
    background: var(--color-accent-hover);
    transform: translateY(-1px);
  }
  
  .dish-card .more-btn {
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }
  
  .dish-card .more-btn:hover {
    background: var(--color-accent-light);
    color: var(--color-accent);
    border-color: var(--color-accent);
  }
  
  /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π */
  .empty-recommendations {
    text-align: center;
    padding: 40px;
    color: var(--color-text-muted);
  }
  
  /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
  @media (max-width: 1024px) {
    /* –ù–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö —Å–¥–≤–∏–≥–∞–µ–º –º–µ–Ω—å—à–µ */
    body.cart-open .ai-page-wrapper {
        transform: translateX(-150px);
        margin-right: 350px;
    }
    
    body.cart-open .ai-recommendations {
        transform: translateX(-50%) translateX(-150px);
    }
    
    .ai-chat-card {
      max-width: 95%;
      height: 70vh;
      min-height: 500px;
    }
    
    .cards {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
    
    .message {
      max-width: 85%;
    }
  }
  
  @media (max-width: 768px) {
    .ai-page-wrapper {
      margin: 20px auto;
      min-height: calc(100vh - 100px);
    }
    
    /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–¥–≤–∏–≥–∞–µ–º –ø–æ-–¥—Ä—É–≥–æ–º—É */
    body.cart-open .ai-page-wrapper {
        transform: translateX(0);
        margin-right: 0;
        margin-left: -80%; /* –°–¥–≤–∏–≥–∞–µ–º –≤–ª–µ–≤–æ –ø–æ–∫–∞–∑—ã–≤–∞—è —á–∞—Å—Ç—å –∫–æ—Ä–∑–∏–Ω—ã */
    }
    
    body.cart-open .ai-recommendations {
        transform: translateX(-50%) translateX(-40%);
        max-width: 90%;
    }
    
    .ai-chat-card {
      height: 68vh;
      min-height: 450px;
      border-radius: var(--radius-md);
    }
    
    .ai-recommendations {
      width: calc(100% - 24px);
      bottom: 12px;
    }
    
    .messages {
      padding: 16px;
      gap: 16px;
    }
    
    .composer {
      padding: 16px;
    }
    
    .composer button {
      padding: 12px 20px;
      min-width: 100px;
    }
    
    .cards {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    .ai-chat-card {
      height: 65vh;
      min-height: 400px;
    }
    
    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∫–æ—Ä–∑–∏–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö */
    body.cart-open .ai-page-wrapper {
        margin-left: 0;
        opacity: 0.7;
        pointer-events: none;
    }
    
    body.cart-open .ai-recommendations {
        opacity: 0.5;
        pointer-events: none;
    }
    
    .ai-chat-header {
      padding: 16px;
    }
    
    .ai-chat-title {
      font-size: 18px;
    }
    
    .message {
      max-width: 90%;
      padding: 12px 16px;
      font-size: 14px;
    }
    
    .composer {
      flex-direction: column;
    }
    
    .composer textarea {
      width: 100%;
      margin-bottom: 8px;
    }
    
    .composer button {
      width: 100%;
      height: 48px;
    }
    
    .mini-bar {
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
      padding: 14px;
    }
    
    #toggleRecs {
      width: 100%;
    }
    
    .dish-card .row {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    
    .dish-card .row > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  }
  
  /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
  @media (max-height: 600px) {
    .ai-chat-card {
      height: 60vh;
      min-height: 350px;
    }
    
    .ai-chat-card.with-recs {
      margin-bottom: 250px;
    }
    
    .recommendation-panel {
      max-height: 250px;
    }
    
    .dish-card .img {
      height: 100px;
    }
  }
</style>
</head>
<body class="page">

 <!-- –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <!-- –ö–Ω–æ–ø–∫–∞ –ì–ª–∞–≤–Ω–∞—è —Å–ª–µ–≤–∞ -->
                <a href="../index.html" class="nav-btn">–ì–ª–∞–≤–Ω–∞—è</a>
                
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                <div class="nav-right">
                    <a href="about.html" class="nav-btn">–û –Ω–∞—Å</a>
                    <a href="contacts.html" class="nav-btn">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
                    <button class="nav-btn login-btn" id="loginBtn" type="button">–í–æ–π—Ç–∏</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ä–∑–∏–Ω—ã (–∏–∑ menu.html) -->
    <button class="cart-toggle" id="cartToggle" type="button">
        <span class="cart-icon">üõí</span>
        <span class="cart-count" id="cartCount">0</span>
    </button>

    <!-- –ü–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã (–∏–∑ menu.html) -->
    <aside class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h2 class="cart-title">–í–∞—à –∑–∞–∫–∞–∑</h2>
            <button class="cart-close" id="cartClose" type="button">&times;</button>
        </div>
        
        <div class="cart-content">
            <div class="cart-items" id="cartItems">
                <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                <div class="empty-cart" id="emptyCart">
                    <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                </div>
            </div>
            
            <div class="cart-footer">
                <div class="cart-total">
                    <span class="total-label">–ò—Ç–æ–≥–æ:</span>
                    <span class="total-amount" id="totalAmount">0‚ÇΩ</span>
                </div>
                <button class="checkout-btn" id="checkoutBtn" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </aside>

  <div class="ai-page-wrapper">
    <section class="ai-chat-card" role="main" aria-labelledby="chatTitle">
      <div class="ai-chat-header">
        <div>
          <h1 class="ai-chat-title" id="chatTitle">–í–∞—à –æ—Ñ–∏—Ü–∏–∞–Ω—Ç: Ai–≥–µ—Ä–∏–º</h1>
          <div class="ai-chat-subtitle">–Ø –ø–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –±–ª—é–¥–æ –∏ –¥–æ–±–∞–≤–ª—é –µ–≥–æ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
        </div>
      </div>

      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="composer">
        <textarea 
          id="chatInput" 
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
          aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ —Å –ò–ò"
          rows="1"
        ></textarea>
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>

  <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–Ω–∏–∑—É -->
  <div class="ai-recommendations" id="aiRecs">
    <div class="mini-bar" id="miniBar">
      <div class="mini-bar-content">
        <div>
          <div class="mini-bar-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç –ò–ò</div>
          <div class="mini-bar-subtitle" id="miniSubtitle">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å</div>
        </div>
      </div>
      <button id="toggleRecs" aria-expanded="false">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
    </div>

    <div class="recommendation-panel" id="recPanel" role="region" aria-hidden="true">
      <div class="cards" id="recCards"></div>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∫–æ—Ä–∑–∏–Ω—ã -->
 <script>
    // ==============================
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–û–†–ó–ò–ù–´ (–¢–û–ß–ù–û –ö–ê–ö –í MENU.JS)
    // ==============================
    const CONFIG = {
        CART: {
            STORAGE_KEY: 'tea_house_cart'
        }
    };

    // ==============================
    // –°–û–°–¢–û–Ø–ù–ò–ï –ö–û–†–ó–ò–ù–´
    // ==============================
    let cart = [];
    let isCartOpen = false;

    // ==============================
    // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´ (–ö–ê–ö –í MENU.JS)
    // ==============================

    /**
     * –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ localStorage
     */
    function loadCart() {
        try {
            const savedCart = localStorage.getItem(CONFIG.CART.STORAGE_KEY);
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã:', error);
            cart = [];
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ localStorage
     */
    function saveCart() {
        try {
            localStorage.setItem(CONFIG.CART.STORAGE_KEY, JSON.stringify(cart));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã:', error);
        }
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É (–°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–û –° MENU.JS)
     */
    function addToCart(dishId, dishName = null, price = null) {
        console.log('üõí === –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ö–û–†–ó–ò–ù–£ ===');
        console.log(`  –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ID=${dishId} (—Ç–∏–ø: ${typeof dishId}), name="${dishName}", price=${price}`);
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º ID –∫ –ß–ò–°–õ–£
        const numericId = Number(dishId);
        console.log(`  –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π ID: ${numericId} (—Ç–∏–ø: ${typeof numericId})`);
        
        // –ï—Å–ª–∏ dishName –∏ price –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –ø–æ–ª—É—á–∞–µ–º –∏–∑ DOM
        if (!dishName || !price) {
            const dishCard = document.querySelector(`[data-dish-id="${numericId}"]`);
            if (dishCard) {
                const nameElement = dishCard.querySelector('h4');
                const priceElement = dishCard.querySelector('.price');
                
                if (nameElement) {
                    dishName = nameElement.textContent;
                    console.log(`  –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ DOM: ${dishName}`);
                }
                if (priceElement) {
                    const priceText = priceElement.textContent.replace('‚ÇΩ', '').trim();
                    price = parseInt(priceText) || 0;
                    console.log(`  –¶–µ–Ω–∞ –∏–∑ DOM: ${price}`);
                }
            }
        }

        // –ò—â–µ–º —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ (–°–¢–†–û–ì–û–ï –°–†–ê–í–ù–ï–ù–ò–ï –∫–∞–∫ –≤ menu.js)
        const existingItem = cart.find(item => item.id === numericId);
        console.log(`  –ù–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ:`, existingItem);
        
        if (existingItem) {
            existingItem.quantity += 1;
            console.log(`  –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${existingItem.quantity}`);
        } else {
            const newItem = {
                id: numericId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –ß–ò–°–õ–û
                name: dishName || `–ë–ª—é–¥–æ #${numericId}`,
                price: price || 0,
                quantity: 1
            };
            cart.push(newItem);
            console.log(`  –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä:`, newItem);
        }
        
        console.log(`  –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:`, cart);
        saveCart();
        updateCartUI(); // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
        showAddToCartFeedback(numericId);
        
        console.log('‚úÖ === –¢–û–í–ê–† –î–û–ë–ê–í–õ–ï–ù ===\n');
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
     */
    function updateCartItemQuantity(itemId, newQuantity) {
        const numericId = Number(itemId);
        const item = cart.find(item => item.id === numericId);
        
        if (item) {
            if (newQuantity <= 0) {
                removeFromCart(numericId);
            } else {
                item.quantity = newQuantity;
                saveCart();
                updateCartUI();
            }
        }
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
     */
    function removeFromCart(itemId) {
        const numericId = Number(itemId);
        cart = cart.filter(item => item.id !== numericId);
        saveCart();
        updateCartUI();
    }

    /**
     * –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
     */
    function showAddToCartFeedback(dishId) {
        const numericId = Number(dishId);
        const dishCard = document.querySelector(`[data-dish-id="${numericId}"]`);
        
        if (dishCard) {
            dishCard.style.transform = 'scale(1.05)';
            dishCard.style.boxShadow = '0 8px 25px rgba(205, 127, 50, 0.4)';
            
            setTimeout(() => {
                dishCard.style.transform = '';
                dishCard.style.boxShadow = '';
            }, 300);
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–æ—Ä–∑–∏–Ω—ã (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!)
     */
    function updateCartUI() {
    console.log('üîÑ === –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ö–û–†–ó–ò–ù–´ ===');
    console.log(`  –ö–æ—Ä–∑–∏–Ω–∞:`, cart);
    
    // –ù–ê–•–û–î–ò–ú –≠–õ–ï–ú–ï–ù–¢–´ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —Å–∫—Ä—ã—Ç—ã)
    const cartCount = document.getElementById('cartCount');
    const cartItems = document.getElementById('cartItems');
    const emptyCart = document.getElementById('emptyCart');
    const totalAmount = document.getElementById('totalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    console.log('  –ù–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', {
        cartCount: !!cartCount,
        cartItems: !!cartItems,
        emptyCart: !!emptyCart,
        totalAmount: !!totalAmount,
        checkoutBtn: !!checkoutBtn
    });
    
    // –ï–°–õ–ò emptyCart –ù–ï –ù–ê–ô–î–ï–ù - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ –Ω–µ–≥–æ
    if (!cartCount || !cartItems || !totalAmount || !checkoutBtn) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
        return;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
    console.log(`  –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω: ${totalItems}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    if (cart.length === 0) {
        // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
        if (emptyCart) {
            emptyCart.style.display = 'block';
        }
        cartItems.innerHTML = '';
        console.log('  –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
    } else {
        // –ï—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã
        if (emptyCart) {
            emptyCart.style.display = 'none';
        }
        
        const itemsHTML = cart.map(item => `
            <div class="cart-item" data-item-id="${item.id}">
                <div class="item-info">
                    <div class="item-name">${item.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä'}</div>
                    <div class="item-price">${item.price || 0}‚ÇΩ</div>
                </div>
                <div class="item-quantity">
                    <button class="quantity-btn minus" onclick="window.updateCartItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn plus" onclick="window.updateCartItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                </div>
                <button class="remove-btn" onclick="window.removeFromCart(${item.id})" title="–£–¥–∞–ª–∏—Ç—å">
                    √ó
                </button>
            </div>
        `).join('');
        
        cartItems.innerHTML = itemsHTML;
        console.log(`  –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω (${cart.length} –ø–æ–∑–∏—Ü–∏–π)`);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    totalAmount.textContent = `${total}‚ÇΩ`;
    console.log(`  –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: ${total}‚ÇΩ`);
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º/–¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
    checkoutBtn.disabled = cart.length === 0;
    console.log(`  –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: ${checkoutBtn.disabled ? '–æ—Ç–∫–ª—é—á–µ–Ω–∞' : '–∞–∫—Ç–∏–≤–Ω–∞'}`);
    
    console.log('‚úÖ === –ò–ù–¢–ï–†–§–ï–ô–° –û–ë–ù–û–í–õ–ï–ù ===\n');
}

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
     */
    async function handleCheckout() {
        if (cart.length === 0) return;
        
        try {
            // –¢–µ –∂–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã, —á—Ç–æ –∏ –≤ menu.js
            const endpoints = ['/api/orders/create', '/api/orders'];
            let success = false;
            let responseData;
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ items –≤ —Ñ–æ—Ä–º–µ [{dish_id, quantity}]
            const items = cart.map(i => ({ dish_id: i.id, quantity: i.quantity }));
            
            for (const ep of endpoints) {
                try {
                    const res = await fetch(ep, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            table_number: "0",
                            items: items,
                            guest_phone: localStorage.getItem('guest_phone') || null,
                            guest_name: localStorage.getItem('guest_name') || null
                        })
                    });
                    
                    if (!res.ok) continue;
                    const j = await res.json();
                    
                    if (j && (j.success || j.order_id || j.id)) {
                        success = true;
                        responseData = j;
                        break;
                    }
                } catch (e) { /* try next */ }
            }

            if (success) {
                alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°–∫–æ—Ä–æ –º—ã –µ–≥–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–º.');
                cart = [];
                saveCart();
                updateCartUI();
                closeCart();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
     */
    function toggleCart() {
        const cartSidebar = document.getElementById('cartSidebar');
        if (!cartSidebar) return;
        
        if (isCartOpen) {
            closeCart();
        } else {
            openCart();
        }
    }

    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
     */
    function openCart() {
        const cartSidebar = document.getElementById('cartSidebar');
        if (!cartSidebar) return;
        
        cartSidebar.classList.add('open');
        document.body.classList.add('cart-open');
        isCartOpen = true;
        
        if (window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden';
        }
    }

    /**
     * –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
     */
    function closeCart() {
        const cartSidebar = document.getElementById('cartSidebar');
        if (!cartSidebar) return;
        
        cartSidebar.classList.remove('open');
        document.body.classList.remove('cart-open');
        isCartOpen = false;
        document.body.style.overflow = '';
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –≤–Ω–µ –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
     */
    function setupCartClickOutside() {
        document.addEventListener('click', function(event) {
            const cartSidebar = document.getElementById('cartSidebar');
            const cartToggle = document.getElementById('cartToggle');
            
            if (isCartOpen && cartSidebar && !cartSidebar.contains(event.target) && 
                cartToggle && !cartToggle.contains(event.target)) {
                closeCart();
            }
        });
    }

    // ==============================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–†–ó–ò–ù–´
    // ==============================

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üì¶ === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–†–ó–ò–ù–´ ===');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        loadCart();
        console.log(`  –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–æ—Ä–∑–∏–Ω–∞: ${cart.length} —Ç–æ–≤–∞—Ä–æ–≤`);
        
        updateCartUI();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã
        const cartToggle = document.getElementById('cartToggle');
        const cartClose = document.getElementById('cartClose');
        const checkoutBtn = document.getElementById('checkoutBtn');
        
        if (cartToggle) {
            cartToggle.addEventListener('click', toggleCart);
        }
        
        if (cartClose) {
            cartClose.addEventListener('click', closeCart);
        }
        
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', handleCheckout);
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isCartOpen) {
                closeCart();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∫–æ—Ä–∑–∏–Ω—ã
        setupCartClickOutside();
        
        console.log('‚úÖ === –ö–û–†–ó–ò–ù–ê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ê ===\n');
    });

    // ==============================
    // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø ONCLICK
    // ==============================

    window.addToCart = addToCart;
    window.updateCartItemQuantity = updateCartItemQuantity;
    window.removeFromCart = removeFromCart;
    window.toggleCart = toggleCart;
    window.closeCart = closeCart;
</script>

  <!-- –§–£–ù–ö–¶–ò–û–ù–ê–õ –ò–ò-–û–§–ò–¶–ò–ê–ù–¢–ê -->
  <script>
    // ==============================
    // –§–£–ù–ö–¶–ò–û–ù–ê–õ –ò–ò-–û–§–ò–¶–ò–ê–ù–¢–ê
    // ==============================
    (function(){
      // –≠–ª–µ–º–µ–Ω—Ç—ã
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      const recPanel = document.getElementById('recPanel');
      const recCards = document.getElementById('recCards');
      const toggleRecs = document.getElementById('toggleRecs');
      const aiChatCard = document.querySelector('.ai-chat-card');
      const miniSubtitle = document.getElementById('miniSubtitle');

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ
      let allDishes = []; // –ö—ç—à –≤—Å–µ—Ö –±–ª—é–¥ (–∫–∞–∫ –≤ menu.js)

      // –ê–≤—Ç–æ—Ä–µ—Å–∞–π–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è
      inputEl.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      setTimeout(() => inputEl.focus(), 100);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      appendMessage('–ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî Ai–≥–µ—Ä–∏–º. –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ –±–ª—é–¥–∞—Ö, –¥–∏–µ—Ç–∞—Ö –∏–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –¥–ª—è –∑–∞–∫–∞–∑–∞.', 'bot');

      // –°–ª—É—à–∞—Ç–µ–ª–∏
      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      toggleRecs.addEventListener('click', () => {
        if (recPanel.classList.contains('open')) {
          collapseRecs();
        } else {
          expandRecs();
        }
      });

      // ==============================
      // –£–¢–ò–õ–ò–¢–´ –ü–û–ò–°–ö–ê
      // ==============================

      /**
       * –ò—â–µ—Ç –±–ª—é–¥–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
       */
      function findDishByName(dishName) {
          if (!dishName || !allDishes.length) return null;
          
          const cleanName = dishName.toLowerCase().trim();
          
          // 1. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          let dish = allDishes.find(d => 
              d.name && d.name.toLowerCase().trim() === cleanName
          );
          
          // 2. –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          if (!dish) {
              dish = allDishes.find(d => 
                  d.name && d.name.toLowerCase().includes(cleanName)
              );
          }
          
          // 3. –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
          if (!dish) {
              dish = allDishes.find(d => {
                  if (!d.name) return false;
                  const nameParts = cleanName.split(' ');
                  return nameParts.some(part => 
                      part.length > 2 && d.name.toLowerCase().includes(part)
                  );
              });
          }
          
          return dish;
      }

      // ==============================
      // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (–∫–∞–∫ –≤ menu.js)
      // ==============================

      /**
       * –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –±–ª—é–¥ –∏–∑ –ë–î
       */
      async function loadAllDishes() {
          try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ database.js —á—Ç–æ –∏ –≤ menu.js
              const { default: db } = await import('/db/database.js?v=' + Date.now());
              
              // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞
              const dishesResponse = await db.getDishes();
              
              if (!dishesResponse) {
                  throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
              }
              
              let loadedDishes = [];
              
              if (Array.isArray(dishesResponse)) {
                  loadedDishes = dishesResponse;
              } else if (dishesResponse.data && Array.isArray(dishesResponse.data)) {
                  loadedDishes = dishesResponse.data;
              } else if (dishesResponse.success && dishesResponse.data && Array.isArray(dishesResponse.data)) {
                  loadedDishes = dishesResponse.data;
              } else if (typeof dishesResponse === 'object') {
                  loadedDishes = Object.values(dishesResponse);
              }
              
              // Normalization: convert any { id -> Id } expectations
              loadedDishes = loadedDishes.map(d => {
                  return Object.assign({}, d, { 
                      Id: d.Id || d.id || d.dish_id,
                      id: d.id || d.Id || d.dish_id,
                      name: d.name || d.Name || ''
                  });
              });
              
              allDishes = loadedDishes;
              return allDishes;
              
          } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥:', error);
              return [];
          }
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      (async function init() {
          await loadAllDishes();
      })();

      // ==============================
      // –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê
      // ==============================

      function appendMessage(text, who = 'bot') {
        const el = document.createElement('div');
        el.className = 'message ' + (who === 'user' ? 'user' : 'bot');
        el.innerText = text;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        el.setAttribute('data-time', timeString);
        
        messagesEl.appendChild(el);
        
        // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
        messagesEl.scrollTo({
          top: messagesEl.scrollHeight,
          behavior: 'smooth'
        });
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendBtn.disabled = true;
        sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        
        appendMessage(text, 'user');
        inputEl.value = '';
        inputEl.style.height = 'auto';
        
        try {
          const res = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, top_k: 3 })
          });
          
          if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + res.status);
          const payload = await res.json();
          
          if (!payload || !payload.success) {
            appendMessage('–ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'bot');
            return;
          }

          const data = payload.data || {};
          const message = data.message || '–ì–æ—Ç–æ–≤–æ.';
          appendMessage(message, 'bot');

          const suggestions = Array.isArray(data.suggestions) ? data.suggestions : [];
          if (suggestions.length > 0) {
            renderRecommendations(suggestions.slice(0, 3));
            expandRecs();
          } else {
            collapseRecs();
          }

        } catch (err) {
          console.error(err);
          appendMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.', 'bot');
        } finally {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          sendBtn.disabled = false;
          sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        }
      }

      async function renderRecommendations(items) {
        recCards.innerHTML = '';
        
        if (!items || items.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'empty-recommendations';
          emptyMsg.innerHTML = '<p>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>';
          recCards.appendChild(emptyMsg);
          return;
        }

        // –ï—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–Ω–æ–≤–∞
        if (allDishes.length === 0) {
          await loadAllDishes();
        }

        items.forEach(item => {
          if (typeof item === 'string') {
            const box = document.createElement('div');
            box.className = 'dish-card';
            box.innerHTML = `
              <div class="body">
                <h4>${escapeHtml(item)}</h4>
                <p>–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –±–ª—é–¥–æ</p>
                <div class="row">
                  <div class="price">‚Äî</div>
                  <button class="more-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                </div>
              </div>
            `;
            recCards.appendChild(box);
            return;
          }

          const dish = item.dish || item;
          const dishIdFromAI = dish.id ? Number(dish.id) : null;
          
          // –ò—â–µ–º –±–ª—é–¥–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î
          let fullDish = null;
          
          if (dishIdFromAI) {
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID
            fullDish = allDishes.find(d => {
              const dId = d.Id || d.id || d.dish_id;
              return dId == dishIdFromAI;
            });
          }
          
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ ID, –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
          if (!fullDish && dish.name) {
            fullDish = findDishByName(dish.name);
          }
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω–∞—à–ª–∏, –∏–Ω–∞—á–µ –±–∞–∑–æ–≤—ã–µ –æ—Ç –ò–ò
          const finalDish = fullDish || dish;
          const finalDishId = fullDish ? (fullDish.Id || fullDish.id) : dishIdFromAI;
          
          const dishName = finalDish.name || '–ë–ª—é–¥–æ';
          const dishPrice = finalDish.price !== undefined ? Math.round(finalDish.price) : '';
          const dishDescription = finalDish.description || dish.category || '';
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
          let imageUrl = '../static/images/no-image.png';
          
          if (finalDish.image_url && finalDish.image_url !== 'null' && finalDish.image_url !== 'undefined') {
            if (finalDish.image_url.startsWith('/static/')) {
              imageUrl = `..${finalDish.image_url}`;
            } else if (finalDish.image_url.startsWith('http')) {
              imageUrl = finalDish.image_url;
            } else {
              imageUrl = finalDish.image_url;
            }
          } else if (finalDish.image_path) {
            if (finalDish.image_path.startsWith('/images/')) {
              imageUrl = `../static${finalDish.image_path}`;
            } else if (finalDish.image_path.startsWith('images/')) {
              imageUrl = `../static/${finalDish.image_path}`;
            } else {
              imageUrl = `../static/images/${finalDish.image_path}`;
            }
          } else if (finalDishId) {
            imageUrl = `../static/images/dishes/${finalDishId}.jpg`;
          }

          const card = document.createElement('div');
          card.className = 'dish-card';
          
          if (finalDishId) {
            card.setAttribute('data-dish-id', finalDishId);
          }
          
          card.innerHTML = `
            <div class="img" style="background-image:url('${escapeAttr(imageUrl)}'); background-color: var(--color-primary);" 
                 onerror="this.style.backgroundImage='url(\'../static/images/no-image.png\')';">
            </div>
            <div class="body">
              <h4>${escapeHtml(dishName)}</h4>
              <p>${escapeHtml(dishDescription)}</p>
              <div class="row">
                <div class="price">${dishPrice ? dishPrice + ' ‚ÇΩ' : ''}</div>
                <div style="display:flex;gap:8px;">
                  <button class="add-btn" aria-label="–î–æ–±–∞–≤–∏—Ç—å ${escapeHtml(dishName)} –≤ –∫–æ—Ä–∑–∏–Ω—É"
                          ${finalDishId ? '' : 'disabled'}
                          data-dish-id="${finalDishId || ''}">
                    ${finalDishId ? '–ó–∞–∫–∞–∑–∞—Ç—å' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}
                  </button>
                  ${finalDishId ? `<button class="more-btn" aria-label="–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ ${escapeHtml(dishName)}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>` : ''}
                </div>
              </div>
            </div>
          `;

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
          if (finalDishId) {
            const addBtn = card.querySelector('.add-btn');
            const moreBtn = card.querySelector('.more-btn');
            
            addBtn.addEventListener('click', async function() {
    // –ö–†–ò–¢–ò–ß–ï–°–ö–û: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π
    const numericId = Number(finalDishId);
    console.log(`üõí –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è ID: ${numericId} (–±—ã–ª–æ: ${finalDishId}, —Ç–∏–ø: ${typeof finalDishId})`);
    
    await window.addToCart(numericId, dishName, dishPrice);
    appendMessage('–î–æ–±–∞–≤–∏–ª "' + dishName + '" –≤ –∫–æ—Ä–∑–∏–Ω—É ‚úì', 'bot');
});
            
            if (moreBtn) {
              moreBtn.addEventListener('click', () => openDishDetails(finalDishId));
            }
          } else {
            const addBtn = card.querySelector('.add-btn');
            addBtn.disabled = true;
            addBtn.title = 'ID –±–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω';
          }

          recCards.appendChild(card);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
        const count = items.length;
        const wordForm = getRussianWordForm(count, ['—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π']);
        miniSubtitle.textContent = `${count} ${wordForm}`;
      }

      function openDishDetails(dishId) {
        if (!dishId) return;
        window.location.href = '/menu/dishes/' + dishId;
      }

      function expandRecs() {
        recPanel.classList.add('open');
        recPanel.setAttribute('aria-hidden', 'false');
        toggleRecs.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å';
        toggleRecs.setAttribute('aria-expanded', 'true');
        aiChatCard.classList.add('with-recs');
      }

      function collapseRecs() {
        recPanel.classList.remove('open');
        recPanel.setAttribute('aria-hidden', 'true');
        toggleRecs.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
        toggleRecs.setAttribute('aria-expanded', 'false');
        aiChatCard.classList.remove('with-recs');
      }

      // ==============================
      // –£–¢–ò–õ–ò–¢–´
      // ==============================

      function escapeHtml(s) {
        if (!s) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      
      function escapeAttr(s) {
        return escapeHtml(s).replace(/'/g, '&#39;').replace(/"/g, '&#34;');
      }
      
      function getRussianWordForm(number, words) {
        const cases = [2, 0, 1, 1, 1, 2];
        return words[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
      }

    })();
  </script>

</body>
</html>